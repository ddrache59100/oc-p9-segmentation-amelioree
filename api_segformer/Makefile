# Makefile pour l'API SegFormer P9

# Variables
VENV_NAME = venv_p9
PYTHON = python3.10
VENV_PYTHON = $(VENV_NAME)/bin/python
VENV_PIP = $(VENV_NAME)/bin/pip

# Variables pour les tests
TEST_IMAGE = test_images/test_000.png
TEST_IMAGES = test_images/test_00*.png
API_URL ?= http://localhost:5000

# Variables Azure
AZURE_APP_NAME ?= oc-p9-segformer
AZURE_RESOURCE_GROUP ?= rg-p9-segformer

.PHONY: help venv install run test clean all

help:
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë          API SegFormer P9 - Commandes disponibles             ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üöÄ D√âMARRAGE RAPIDE:"
	@echo "  make setup        - Installation compl√®te (venv + d√©pendances)"
	@echo "  make dev          - Mode d√©veloppement (B1 INT8 par d√©faut)"
	@echo "  make test-quick   - Test rapide avec une image"
	@echo ""
	@echo "üì¶ INSTALLATION:"
	@echo "  make venv         - Cr√©er l'environnement virtuel"
	@echo "  make install      - Installer les d√©pendances"
	@echo ""
	@echo "üèÉ EX√âCUTION - MOD√àLES INT8:"
	@echo "  make run          - Lancer l'API (B1 INT8 par d√©faut)"
	@echo "  make run-b0       - SegFormer-B0 INT8 (4.6 MB, IoU: 0.587)"
	@echo "  make run-b1       - SegFormer-B1 INT8 (14.2 MB, IoU: 0.667)"
	@echo "  make run-b2       - SegFormer-B2 INT8 (28.3 MB, IoU: 0.705)"
	@echo ""
	@echo "üèÉ EX√âCUTION - MOD√àLES FP32:"
	@echo "  make run-b0-fp32  - SegFormer-B0 FP32 (14.5 MB, IoU: 0.698)"
	@echo "  make run-b1-fp32  - SegFormer-B1 FP32 (52.5 MB, IoU: 0.701)"
	@echo "  make run-b2-fp32  - SegFormer-B2 FP32 (104.9 MB, IoU: 0.760)"
	@echo ""
	@echo "üß™ TESTS:"
	@echo "  make test         - Tests unitaires de l'API"
	@echo "  make test-quick   - Test rapide avec une image"
	@echo "  make test-all     - Tests sur toutes les images"
	@echo "  make test-batch   - Test batch sur 5 premi√®res images"
	@echo "  make test-visual  - Test avec visualisation"
	@echo ""
	@echo "‚ö° BENCHMARKS:"
	@echo "  make benchmark       - Benchmark des 3 mod√®les INT8"
	@echo "  make benchmark-full  - Benchmark complet INT8 vs FP32"
	@echo "  make benchmark-detail - Benchmark d√©taill√© avec statistiques"
	@echo ""
	@echo "‚òÅÔ∏è  AZURE - D√âPLOIEMENT:"
	@echo "  make azure-prepare    - Pr√©parer le package de d√©ploiement"
	@echo "  make azure-check      - V√©rifier le package avant d√©ploiement"
	@echo "  make azure-deploy     - D√©ployer sur Azure F1"
	@echo "  make azure-update     - Mettre √† jour l'app d√©ploy√©e"
	@echo ""
	@echo "‚òÅÔ∏è  AZURE - MONITORING:"
	@echo "  make azure-test       - Tester l'API d√©ploy√©e"
	@echo "  make azure-status     - V√©rifier le statut Azure"
	@echo "  make azure-logs       - Voir les logs en temps r√©el"
	@echo "  make azure-stop       - Arr√™ter l'app (√©conomiser cr√©dits)"
	@echo "  make azure-start      - Red√©marrer l'app"
	@echo ""
	@echo "üßπ MAINTENANCE:"
	@echo "  make clean        - Nettoyer les fichiers temporaires"
	@echo "  make clean-all    - Nettoyer tout (y compris venv)"
	@echo "  make status       - Voir l'√©tat complet du projet"
	@echo "  make refresh      - Recr√©er l'environnement (clean + setup)"
	@echo ""
	@echo "üìä VISUALISATION:"
	@echo "  make visualize    - Visualiser les r√©sultats de segmentation"

# Installation compl√®te
setup: venv install
	@echo "‚úÖ Installation compl√®te termin√©e!"
	@echo "Lancez 'make dev' pour d√©marrer"

# Cr√©er le virtualenv
$(VENV_NAME):
	@echo "üîß Cr√©ation de l'environnement virtuel..."
	@which $(PYTHON) > /dev/null || (echo "‚ùå Erreur: $(PYTHON) n'est pas install√©" && exit 1)
	$(PYTHON) -m venv $(VENV_NAME)
	@echo "‚úÖ Environnement virtuel cr√©√©"

venv: $(VENV_NAME)

# Installer les d√©pendances
install: $(VENV_NAME)
	@echo "üì¶ Installation des d√©pendances..."
	$(VENV_PIP) install --upgrade pip
	$(VENV_PIP) install -r requirements.txt
	@echo "‚úÖ D√©pendances install√©es"

# Mode d√©veloppement
dev: $(VENV_NAME)
	@echo "üöÄ Lancement en mode d√©veloppement..."
	@echo "üìç URL: http://localhost:5000"
	@echo "ü§ñ Mod√®le: SegFormer-B1 INT8 (14.2 MB, IoU: 0.667)"
	@echo "üí° Mode Lazy Loading activ√© - le mod√®le sera charg√© √† la premi√®re requ√™te"
	@echo ""
	$(VENV_PYTHON) src/app.py

# Lancer avec diff√©rents mod√®les INT8
run: dev

run-b0: $(VENV_NAME)
	@echo "üöÄ Lancement avec SegFormer-B0 INT8 (4.6 MB)..."
	DEFAULT_MODEL=segformer_b0_int8 $(VENV_PYTHON) src/app.py

run-b1: $(VENV_NAME)
	@echo "üöÄ Lancement avec SegFormer-B1 INT8 (14.2 MB)..."
	DEFAULT_MODEL=segformer_b1_int8 $(VENV_PYTHON) src/app.py

run-b2: $(VENV_NAME)
	@echo "üöÄ Lancement avec SegFormer-B2 INT8 (28.3 MB)..."
	DEFAULT_MODEL=segformer_b2_int8 $(VENV_PYTHON) src/app.py

# Lancer les mod√®les FP32
run-b0-fp32: $(VENV_NAME)
	@echo "üöÄ Lancement avec SegFormer-B0 FP32 (14.5 MB)..."
	DEFAULT_MODEL=segformer_b0_fp32 $(VENV_PYTHON) src/app.py

run-b1-fp32: $(VENV_NAME)
	@echo "üöÄ Lancement avec SegFormer-B1 FP32 (52.5 MB)..."
	DEFAULT_MODEL=segformer_b1_fp32 $(VENV_PYTHON) src/app.py

run-b2-fp32: $(VENV_NAME)
	@echo "üöÄ Lancement avec SegFormer-B2 FP32 (104.9 MB)..."
	DEFAULT_MODEL=segformer_b2_fp32 $(VENV_PYTHON) src/app.py

# Tests
test: $(VENV_NAME)
	@echo "üß™ Test de l'API..."
	$(VENV_PYTHON) tests/test_api.py

test-quick: $(VENV_NAME)
	@echo "üß™ Test rapide avec une image..."
	@echo "Image: $(TEST_IMAGE)"
	API_URL=$(API_URL) $(VENV_PYTHON) tests/test_api.py $(TEST_IMAGE)

test-all: $(VENV_NAME)
	@echo "üß™ Test avec toutes les images..."
	@for img in $(TEST_IMAGES); do \
		echo "Testing $$img..."; \
		API_URL=$(API_URL) $(VENV_PYTHON) tests/test_api.py $$img; \
	done

test-batch: $(VENV_NAME)
	@echo "üß™ Test batch sur plusieurs images..."
	@for i in 000 001 002 003 004; do \
		echo "\nüì∏ Test image test_$$i.png..."; \
		$(VENV_PYTHON) tests/test_api.py test_images/test_$$i.png; \
	done
	@echo "\n‚úÖ Batch test termin√©"
	@echo "R√©sultats dans: test_results/"

# Visualisation des r√©sultats
visualize: $(VENV_NAME)
	@echo "üìä Visualisation des r√©sultats..."
	@$(VENV_PYTHON) tests/compare_results.py

test-visual: test-quick visualize
	@echo "‚úÖ Test et visualisation termin√©s"

# Benchmark
benchmark: $(VENV_NAME)
	@echo "‚ö° Benchmark des 3 mod√®les INT8..."
	@echo "Assurez-vous que l'API est lanc√©e!"
	@for model in b0 b1 b2; do \
		echo "\nüìä Test SegFormer-$$model INT8..."; \
		curl -X POST -F "image=@$(TEST_IMAGE)" \
			$(API_URL)/predict?model=segformer_$${model}_int8 \
			-w "\nTemps total: %{time_total}s\n"; \
	done

benchmark-full: $(VENV_NAME)
	@echo "‚ö° Benchmark complet INT8 vs FP32..."
	@echo "Assurez-vous que l'API est lanc√©e!"
	@echo ""
	@for variant in b0 b1 b2; do \
		echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"; \
		echo "üìä SegFormer-$$variant"; \
		echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"; \
		echo "\n‚ñ∂ FP32:"; \
		curl -s -X POST -F "image=@$(TEST_IMAGE)" \
			$(API_URL)/predict?model=segformer_$${variant}_fp32 \
			-w "\nTemps total: %{time_total}s\n" 2>/dev/null | grep -E "(model|inference_time)"; \
		echo "\n‚ñ∂ INT8:"; \
		curl -s -X POST -F "image=@$(TEST_IMAGE)" \
			$(API_URL)/predict?model=segformer_$${variant}_int8 \
			-w "\nTemps total: %{time_total}s\n" 2>/dev/null | grep -E "(model|inference_time)"; \
		echo ""; \
	done

benchmark-detail: $(VENV_NAME)
	@echo "üìä Benchmark d√©taill√© FP32 vs INT8..."
	@echo "Assurez-vous que l'API est lanc√©e!"
	$(VENV_PIP) install tabulate 2>/dev/null || true
	$(VENV_PYTHON) tests/benchmark_complete.py

# Nettoyage
clean:
	@echo "üßπ Nettoyage..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	rm -rf test_results/*.png
	rm -rf azure_deploy_minimal
	@echo "‚úÖ Nettoyage termin√©"

clean-all: clean
	@echo "üóëÔ∏è  Suppression de l'environnement virtuel..."
	rm -rf $(VENV_NAME)
	@echo "‚úÖ Nettoyage complet termin√©"

refresh: clean-all setup
	@echo "‚ôªÔ∏è  Environnement recr√©√© avec succ√®s"

# Status
status:
	@echo "üìä √âtat du projet:"
	@echo ""
	@echo "üìÅ Structure:"
	@echo "  - Mod√®les: $$(ls models/ | wc -l) variants"
	@echo "  - Images test: $$(ls test_images/*.png | grep -v mask | wc -l) images"
	@echo "  - R√©sultats: $$(ls test_results/*.png 2>/dev/null | wc -l) fichiers"
	@echo ""
	@echo "ü§ñ Mod√®les disponibles:"
	@ls -lh models/*/model_quantized.onnx 2>/dev/null || echo "  Mod√®les INT8 non trouv√©s"
	@ls -lh models/*/model.onnx 2>/dev/null || echo "  Mod√®les FP32 non trouv√©s"
	@echo ""
	@if [ -d "$(VENV_NAME)" ]; then \
		echo "üêç Environnement Python: ‚úÖ Install√©"; \
		$(VENV_PYTHON) --version; \
	else \
		echo "üêç Environnement Python: ‚ùå Non install√© (lancez 'make setup')"; \
	fi
	@echo ""
	@if [ -d "azure_deploy_minimal" ]; then \
		echo "‚òÅÔ∏è  Package Azure: ‚úÖ Pr√™t ($$(du -sh azure_deploy_minimal | cut -f1))"; \
	else \
		echo "‚òÅÔ∏è  Package Azure: ‚ùå Non cr√©√© (lancez 'make azure-prepare')"; \
	fi

# ================== COMMANDES AZURE ==================

# Pr√©paration Azure avec script adapt√©
azure-prepare:
	@echo "üì¶ Pr√©paration du d√©ploiement Azure..."
	@chmod +x prepare_minimal_deployment.sh
	./prepare_minimal_deployment.sh

azure-check:
	@echo "üîç V√©rification du package Azure..."
	@if [ -d "azure_deploy_minimal" ]; then \
		echo "üìÅ Contenu du package:"; \
		tree -h azure_deploy_minimal 2>/dev/null || ls -la azure_deploy_minimal/; \
		echo ""; \
		echo "üìä Taille totale: $$(du -sh azure_deploy_minimal | cut -f1)"; \
		echo "‚úÖ Package pr√™t pour d√©ploiement"; \
	else \
		echo "‚ùå Package non cr√©√©. Lancez 'make azure-prepare' d'abord"; \
	fi

# D√©ploiement Azure
azure-deploy: azure-prepare
	@echo "‚òÅÔ∏è  D√©ploiement sur Azure F1..."
	@echo "App: $(AZURE_APP_NAME)"
	@echo "Resource Group: $(AZURE_RESOURCE_GROUP)"
	cd azure_deploy_minimal && az webapp up \
		--name $(AZURE_APP_NAME) \
		--resource-group $(AZURE_RESOURCE_GROUP) \
		--runtime "PYTHON:3.9" \
		--sku F1 \
		--location "West Europe"
	@echo ""
	@echo "‚úÖ D√©ploiement termin√©!"
	@echo "üåê URL: https://$(AZURE_APP_NAME).azurewebsites.net"

azure-update: azure-prepare
	@echo "üîÑ Mise √† jour de l'application Azure..."
	cd azure_deploy_minimal && az webapp deployment source config-zip \
		--name $(AZURE_APP_NAME) \
		--resource-group $(AZURE_RESOURCE_GROUP) \
		--src @<(zip -r - .)
	@echo "‚úÖ Application mise √† jour"

# Tests Azure
azure-test: $(VENV_NAME)
	@echo "üß™ Test de l'API Azure..."
	@echo "URL: https://$(AZURE_APP_NAME).azurewebsites.net"
	API_URL=https://$(AZURE_APP_NAME).azurewebsites.net $(VENV_PYTHON) tests/test_api.py

# Monitoring Azure
azure-logs:
	@echo "üìú Logs Azure (Ctrl+C pour arr√™ter)..."
	az webapp log tail --name $(AZURE_APP_NAME) --resource-group $(AZURE_RESOURCE_GROUP)

azure-status:
	@echo "üìä Statut Azure:"
	@az webapp show --name $(AZURE_APP_NAME) --resource-group $(AZURE_RESOURCE_GROUP) \
		--query "{Status:state, URL:defaultHostName, Plan:appServicePlanId}" -o table 2>/dev/null || \
		echo "‚ùå App non trouv√©e"

azure-stop:
	@echo "‚è∏Ô∏è  Arr√™t de l'application Azure..."
	az webapp stop --name $(AZURE_APP_NAME) --resource-group $(AZURE_RESOURCE_GROUP)
	@echo "‚úÖ Application arr√™t√©e (√©conomie de cr√©dits)"

azure-start:
	@echo "‚ñ∂Ô∏è  Red√©marrage de l'application Azure..."
	az webapp start --name $(AZURE_APP_NAME) --resource-group $(AZURE_RESOURCE_GROUP)
	@echo "‚úÖ Application red√©marr√©e"